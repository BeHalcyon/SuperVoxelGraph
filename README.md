
# SLIC3DSuperVoxel (SLIC algorithm for volume data in 3D space)

Three works are achieved:

**STEP 1. Calculating super-voxels (SLIC3DSuperVoxel)**

This module needs vifo file for calculating super-voxels. The output file is the raw file with the same format with volume data.
Input informaiton:
```c
NEW: *.json: the configure json file.
OLD: *.vifo: the input volume data.
```

Output information:
```c
*_label.raw: the output file with int value from 0 to N-1, where N is the number of super-voxels
*_boundary.raw: the output file with int value from origin volume value and 511, where 511 is boundary for super-voxels.
```


**STEP 2. Calculating histogram for super-voxels (SuperVoxel2Histogram)**

The SuperVoxel2Histogram transfers calucated super-voxels be STEP 1 to node histogram and edge weight where nodes represent the super-voxels and edges are measured by neigboring nodes. The edge weight is set to 1 by default. 

Note that the addition addtional information of each node (label/super-voxel) carries is listed as follows:
1. the normalized scalar histogram with the size of #histogram_size#.
2. the average gradient without normalization (size: 1)
3. the information entropy without normalization (size: 1)
4. the coordinate of the barycenter without normalization (size: 3)
The information length of each super-voxels is #histogram_size#+5.

Input informaiton:
```c
NEW: *.json: the configure json file.
Out of date: *.vifo: the input volume data and dimension information
*_label.raw
```

Output information:
```c
NEW: edge_weight_array.txt: 2D array with the row of label number and column of 3. Each row represents 3 number : i j edge_weight, representing super-voxel i and j are neighboring, and the weight is edge_weight.
Out of date: edge_weight_array.txt: 2D array with the side length of super-voxel number where arr[i][j] = 1 represents super-voxel i and j are neighboring.

label_histogram_array.txt: the normalized scalar histogram for each super-voxel.
```



**STEP 3. Calculating graph for histogram using python(Histogram2Graph)**

The Histogram2Graph transfers the two "txt" file to gexf graph using networkx package.

Input informaiton:
```c
*.json: the input volume data and dimension information
edge_weight_array.txt
label_histogram_array.txt
Aditional: csv files based column labelling the nodes(super-voxels) for supervised learning. The nodes in the same csv file will be allocated to the same cluster id. 
**Note: The csv file is generated by gephi. All the labelled nodes can be interactively selected in the software and copied to a new workspace, and then exported.**
```




Output information:
```c
*_supergraph.gexf: graph file for the volume data.
```

**Note: The nodes currently contain two attributes: histogram information [0, supervoxel2histogram.histogram_size+4], where [0, historam_size-1] are for the histogram inforamtion, [histogram_size ] is for the gradient, [histogram_size+1 ] is for the information entropy, [histogram_size+2, histogram_size+4] are for the coordinate of the barycenter) and cls (defaulted to -1, set to 1 for training set and 2 for test set).**
**Out of Date Note: The nodes currently contain two attributes: histogram information (0-255) and cls (defaulted to -1, set to 1 for training set and 2 for test set).**

**STEP 4. Merging similar super-voxels using graph-based volume segmentation** (Not completed)

Compute the edge weight using the **chi-squared distance** between 1D intensity histograms of the two super-voxels. Each histogram uses a total of 64 bins across the entire scalar range of the input volume.

The segementation algorithm is under testing and is not convincing. There is an error in the measurement of the weight for edges and internal variance of regions. Current internal variance is measured by the maximum gradient difference of the edges in region, while the origin method is using the maximum edge weight of MST of the region.


Using:
```c
SLIC3DSuperVoxel.exe --TAG=parameter_value
```

Example:
```c
SLIC3DSuperVoxel.exe --configure_file="C:/*.json"
```
<!-- ![cmdline](https://github.com/XiangyangHe/SuperVoxelGraph/tree/master/image/cmdline.png) -->


## vifo file format:
-----------------------------------------------------
```cpp
1                   //volume number
uchar               //volume data type in "uchar" "float" "ushort"
500 500 100         //volume dimensions in x y z direction
1 1 1               //volume spaces in x y z direction
SPEEDf21.raw        //volume relative path
```

## configure json format:
-----------------------------------------------------
```cpp
{
    "data_path": {
      "vifo_file": "I:/mixfrac.vifo",
      "volume_index": 0,
      "file_prefix": "I:/jet_mixfrac_0051_"
    },
  
    "file_name":
    {
      "merged_label_file":"merged_label_int.raw",//store all super-voxel ids from zero
      "merged_boundary_file":"merged_boundary_int.raw",//[0, 255] for raw volume, 511 for boundary
      "label_file":"label_int.raw",//store all super-voxel ids from zero
      "boundary_file":"boundary_int.raw",//[0, 255] for raw volume, 511 for boundary
      "gradient_file":"gradient_float.raw",// [0, +oo]
      "label_histogram_file":"label_histogram_array.txt",// 2D arrray, the row represensts all the Quantitative information of a super-voxel
      "edge_weight_file":"edge_weight_array.txt",//2D array that each row lists [i,j,w], representing super-voxel id i and j are neighboring and the weight between them is w
      "graph_file":"supergraph.gexf",//the gephi file that stores the bulided graph
      "node_embedding_file": "node_embedding.emb" //the training result in vecotor form.
    },
    
    "volume2supervoxel":{
      "cluster_number": 8196,//To control the rough number of generated super-voxels
      "output_super_voxel_label": 1,//Whether to output the super-voxel labelled int file
      "output_super_voxel_boundary": 1,//Whether to output the super-voxel boundary int file (this file will be reduced in [0,255], and the boundary is set to 511)
      "output_gradient": 1,//Whether to output the gradient file (in float)
      "k_threshold": 100000,//The value controls the merged results, a greater value contributes to a big super-voxel.
      "is_merge": 0,// Whether to merge the super-voxels
      "output_merged_label": 0,//Whether to output the merged super-voxels
      "output_merged_boundary": 0,//Whether to output the boundary of the merged super-voxels
      "compactness_factor": 20//Compactness factor. The weight given to spatial distance. A greater value contributes to a .Default is 20, and I have test the max value 2000000 will contribute a very regular result (less similar feature)
      //Update: the compactness_factor contorl the maxintensity of each label. The greater value contributes to increase the weight of distance that makes the shape of each super-voxels more tight or regular.
    },

    "supervoxel2histogram":{
      "histogram_size":256,//The histogram length for each label
      "is_histogram_stored":1,//Whether store the historam, default to set to 1 to store
      "is_gradient_stored":1,//Whether store the non-normalized gradient
      "is_entropy_stored":1,//Whether store the entropy
      "is_barycenter_stored":1//Whether store the baycenter
    },
    "histogram2graph":{
      "histogram_size":256//Not yet in use
    },
    //The GCN is for unspervising learning and supervising learning.
    //For the formmer, the only valid parameter is vector_dimension.
    //For the latter, all the parameters in gcn are valid.
    "gcn":{
      "vector_dimension": 256, //The generated vector dimension.
      "epochs": 100,  //The traning epochs
      "learning_rate": 0.01,//The init learning rate
      "warmup_steps": 100,//Warmup steps
      "label_type_number": 1//The number of label types
    }
  }
```





Results for STEP 1:
-----------------------------------------------------

<img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/design%20sketch_xyplane.png" width=350>

<img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/design%20sketch_yzplane.png" width=350>

<img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/design%20sketch_volumerendering.png" width=350>

<img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/design%20sketch_asteroid_tev.png" width=350>

<img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/design%20sketch_MANIX.png" width=350>

<img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/design%20sketch_tooth.png" width=350>


<!-- ![xy plane](https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/design%20sketch_xyplane.png)
![yz plane](https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/design%20sketch_yzplane.png)
![3D results](https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/design%20sketch_volumerendering.png)
![3D results](https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/design%20sketch_asteroid_tev.png)
![3D results](https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/design%20sketch_MANIX.png)
![3D results](https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/design%20sketch_tooth.png) -->


Results for STEP 2 (jet_mixfrix_0051):
-----------------------------------------------------
<!-- <img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/super-voxel-graph.png" width=600>

<img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/super-voxel-graph2.png" width=600> -->

![super-voxel graph](https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/super-voxel-graph.png)
![super-voxel graph](https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/super-voxel-graph2.png)


![sphere volume render result](https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/supergraph_origin_volume.png)
![sphere supergraph](https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/supergraph.png)
![sphere supergraph subregion](https://github.com/XiangyangHe/SuperVoxelGraph/blob/develop/image/supergraph_subregion.png)

Results for STEP 3:
-----------------------------------------------------
(A modification for distance measurement to achieve irregular super-voxels)

<img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/merged_combustion.png" width=600>

<img src="https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/merged_H.png" width=600>

<!-- ![image](https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/merged_combustion.png)
![image](https://github.com/XiangyangHe/SuperVoxelGraph/blob/master/image/merged_H.png) -->

Reference:
-----------------------------------------------------
- [1] SLIC Superpixels Compared to State-of-the-Art Superpixel Methods
- [2] FeatureLego: Volume Exploration Using Exhausting Clustering of Super-Voxels
- [3] Efficient Graph-Based Image Segmentation
